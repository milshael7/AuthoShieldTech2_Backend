// backend/src/routes/security.routes.js
// Enterprise Security Firewall — Hardened v6
// Public Risk Engine • Scoped Data • Session Monitor • Escalation Engine • Audit Safe

const express = require("express");
const router = express.Router();

const { authRequired } = require("../middleware/auth");
const { readDb, writeDb } = require("../lib/db");
const { writeAudit } = require("../lib/audit");
const { getActiveSessionCount } = require("../lib/sessionStore");
const users = require("../users/user.service");

/* =========================================================
   ROLE HELPERS
========================================================= */

function normalize(role) {
  return String(role || "").toLowerCase();
}

function isAdmin(user) {
  return normalize(user.role) === normalize(users.ROLES.ADMIN);
}

function normalizeArray(v) {
  if (!v) return [];
  if (Array.isArray(v)) return v;
  return Object.values(v);
}

/* =========================================================
   PUBLIC DEVICE RISK (NO AUTH)
========================================================= */

router.post("/public-device-risk", (req, res) => {
  try {
    const { userAgent, language, timezone } = req.body || {};

    let riskScore = 10;

    if (!userAgent) riskScore += 20;
    if (!language) riskScore += 10;
    if (!timezone) riskScore += 10;

    if (String(userAgent).toLowerCase().includes("headless")) {
      riskScore += 40;
    }

    riskScore = Math.min(100, riskScore);

    let level = "Low";
    if (riskScore > 60) level = "High";
    else if (riskScore > 30) level = "Medium";

    return res.json({
      ok: true,
      riskScore,
      level
    });

  } catch {
    res.status(500).json({ ok: false });
  }
});

/* =========================================================
   AUTH REQUIRED BELOW
========================================================= */

router.use(authRequired);

/* =========================================================
   ESCALATION ENGINE
========================================================= */

function autoEscalateIfNeeded(db, event, req) {
  if (event.severity !== "critical") return;

  const existing = (db.incidents || []).find(
    (i) => i.sourceEventId === event.id
  );

  if (existing) return;

  const newIncident = {
    id: Date.now().toString(),
    title: `AUTO: ${event.title || "Critical Security Event"}`,
    description: event.description || "",
    severity: "critical",
    status: "open",
    sourceEventId: event.id,
    autoGenerated: true,
    companyId: event.companyId || null,
    createdAt: new Date().toISOString(),
  };

  db.incidents = db.incidents || [];
  db.incidents.push(newIncident);

  writeAudit({
    actor: "system",
    role: "system",
    action: "AUTO_ESCALATION_CREATED",
    detail: { incidentId: newIncident.id }
  });
}

/* =========================================================
   POSTURE SUMMARY (SCOPED)
========================================================= */

router.get("/posture-summary", (req, res) => {
  try {
    const db = readDb();

    const vulnerabilitiesArr = normalizeArray(db.vulnerabilities);
    const usersArr = normalizeArray(db.users);

    let scopedVulns = vulnerabilitiesArr;
    let scopedUsers = usersArr;

    if (!isAdmin(req.user)) {
      scopedVulns = vulnerabilitiesArr.filter(
        v => v.companyId === req.user.companyId
      );

      scopedUsers = usersArr.filter(
        u => u.companyId === req.user.companyId
      );
    }

    const critical = scopedVulns.filter(v => v.severity === "critical").length;
    const high = scopedVulns.filter(v => v.severity === "high").length;
    const medium = scopedVulns.filter(v => v.severity === "medium").length;
    const low = scopedVulns.filter(v => v.severity === "low").length;

    let riskScore = 100 - (critical * 15 + high * 8 + medium * 4 + low);
    riskScore = Math.max(5, Math.min(100, riskScore));

    res.json({
      ok: true,
      scope: isAdmin(req.user) ? "global" : "company",
      totalUsers: scopedUsers.length,
      riskScore: Math.round(riskScore),
      critical,
      high,
      medium,
      low,
      timestamp: Date.now(),
    });

  } catch {
    res.status(500).json({ ok: false });
  }
});

/* =========================================================
   COMPLIANCE (SCOPED)
========================================================= */

router.get("/compliance", (req, res) => {
  try {
    const db = readDb();
    let vulns = db.vulnerabilities || [];

    if (!isAdmin(req.user)) {
      vulns = vulns.filter(
        v => v.companyId === req.user.companyId
      );
    }

    const critical = vulns.filter(v => v.severity === "critical").length;
    const high = vulns.filter(v => v.severity === "high").length;

    let complianceScore = 100 - (critical * 10 + high * 5);
    complianceScore = Math.max(10, Math.min(100, complianceScore));

    res.json({
      ok: true,
      complianceScore,
      critical,
      high
    });

  } catch {
    res.status(500).json({ ok: false });
  }
});

/* =========================================================
   ACTIVE SESSION MONITOR
========================================================= */

router.get("/sessions", (req, res) => {
  try {
    const activeSessions = getActiveSessionCount(req.user.id);

    res.json({
      ok: true,
      userId: req.user.id,
      activeSessions,
      timestamp: Date.now()
    });

  } catch {
    res.status(500).json({ ok: false });
  }
});

/* =========================================================
   SECURITY EVENTS (SCOPED)
========================================================= */

router.get("/events", (req, res) => {
  try {
    const db = readDb();
    let events = normalizeArray(db.securityEvents);

    if (!isAdmin(req.user)) {
      events = events.filter(
        e => e.companyId === req.user.companyId
      );
    }

    events.sort(
      (a, b) =>
        new Date(b.createdAt) - new Date(a.createdAt)
    );

    res.json({
      ok: true,
      events: events.slice(0, 100)
    });

  } catch {
    res.status(500).json({ ok: false });
  }
});

/* =========================================================
   CREATE SECURITY EVENT
========================================================= */

router.post("/events", (req, res) => {
  try {
    const { title, description, severity = "low" } = req.body;

    if (!title) {
      return res.status(400).json({
        ok: false,
        error: "Title required"
      });
    }

    const db = readDb();
    db.securityEvents = db.securityEvents || [];

    const normalizedSeverity =
      ["low", "medium", "high", "critical"].includes(
        severity.toLowerCase()
      )
        ? severity.toLowerCase()
        : "low";

    const newEvent = {
      id: Date.now().toString(),
      title,
      description: description || "",
      severity: normalizedSeverity,
      acknowledged: false,
      companyId: req.user.companyId || null,
      createdAt: new Date().toISOString(),
    };

    db.securityEvents.push(newEvent);

    autoEscalateIfNeeded(db, newEvent, req);

    writeDb(db);

    writeAudit({
      actor: req.user.id,
      role: req.user.role,
      action: "SECURITY_EVENT_CREATED",
      detail: { eventId: newEvent.id }
    });

    res.status(201).json({
      ok: true,
      event: newEvent
    });

  } catch {
    res.status(500).json({ ok: false });
  }
});

/* =========================================================
   VULNERABILITIES (SCOPED)
========================================================= */

router.get("/vulnerabilities", (req, res) => {
  try {
    const db = readDb();
    let vulns = db.vulnerabilities || [];

    if (!isAdmin(req.user)) {
      vulns = vulns.filter(
        v => v.companyId === req.user.companyId
      );
    }

    res.json({
      ok: true,
      vulnerabilities: vulns
    });

  } catch {
    res.status(500).json({ ok: false });
  }
});

module.exports = router;
